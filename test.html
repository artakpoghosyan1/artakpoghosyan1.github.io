<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title><title>WebAssembly Recorder using RecordRTC</title>
        <style type="text/css">
            body {
                text-align: center;
            }

            video {
                border-radius: 5px;
                border: 1px solid black;
            }
            #canvas {
                width: 400px;
                height: 400px;
            }
        </style>

        <h1>WebAssembly Recorder using RecordRTC <span id="version"></span></h1>
        <button id="start">Start Recording</button>
        <button id="stop" disabled>Stop Recording</button>
        <br><br>
        <video id="video" controls autoPlay playsInline></video>
        <video id="videoCapture" controls></video>
        <canvas id="canvas"></canvas>

        <!-- web streams API polyfill to support Firefox -->
        <script src="https://unpkg.com/@mattiasbuelens/web-streams-polyfill/dist/polyfill.min.js"></script>

        <script src="RecordRTC.js"></script>

        <script>
            document.getElementById('version').innerHTML = RecordRTC.version;
            var canvas = document.getElementById('canvas')

            var recorder;

            document.getElementById('start').onclick = function () {
                this.disabled = true;
                navigator.mediaDevices.getUserMedia({
                    video: {
                        width: {
                            ideal: 640
                        },
                        height: {
                            ideal: 480
                        }
                    },
                    audio: false
                }).then(function (stream) {
                    document.getElementById('video').srcObject = stream;

                    var videoCapture = document.getElementById('videoCapture')
                    var stream_ = canvas.captureStream(25);
                    videoCapture.srcObject = stream;

                    recorder = RecordRTC(stream_, {
                        recorderType: WebAssemblyRecorder,
                        // workerPath: '../libs/webm-worker.js',
                        // webAssemblyPath: '../libs/webm-wasm.wasm',
                        width: 640,
                        height: 480,
                        frameRate: 30
                    });
                    recorder.startRecording();

                    document.getElementById('stop').disabled = false;
                });
            };

            document.getElementById('stop').onclick = function () {
                document.getElementById('video').srcObject = null;

                this.disabled = true;
                recorder.stopRecording(function (blob) {
                    document.getElementById('video').src = URL.createObjectURL(recorder.getBlob());
                    document.getElementById('start').disabled = false;
                });
            }


            var canvas = document.getElementById('canvas');
            var context = canvas.getContext('2d');

            var video_ = document.getElementById('video')

            video_.onplay = function() {
                renderFrame()
            }


            function calculateSize(srcSize, dstSize) {
                var srcRatio = srcSize.width / srcSize.height;
                var dstRatio = dstSize.width / dstSize.height;
                if (dstRatio > srcRatio) {
                    return {
                        width:  dstSize.height * srcRatio,
                        height: dstSize.height
                    };
                } else {
                    return {
                        width:  dstSize.width,
                        height: dstSize.width / srcRatio
                    };
                }
            }


            function renderFrame() {
                // re-register callback
                requestAnimationFrame(renderFrame);
                // set internal canvas size to match HTML element size
                canvas.width = canvas.scrollWidth;
                canvas.height = canvas.scrollHeight;
                if (video_.readyState === video_.HAVE_ENOUGH_DATA) {
                    // scale and horizontally center the camera image
                    var videoSize = { width: video_.videoWidth, height: video_.videoHeight };
                    var canvasSize = { width: canvas.width, height: canvas.height };
                    var renderSize = calculateSize(videoSize, canvasSize);
                    var xOffset = (canvasSize.width - renderSize.width) / 2;
                    context.drawImage(video_, xOffset, 0, renderSize.width, renderSize.height);
                }
            }




        </script>
        <footer style="margin-top: 20px;"><small id="send-message"></small></footer>
        <script src="https://www.webrtc-experiment.com/common.js"></script></title>
</head>
<body>

</body>
</html>
